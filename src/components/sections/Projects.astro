---
import Section from "../Section.astro";
import { Icon } from "astro-icon/components";
import { projects } from "@cv";
import fs from "fs";
import path from "path";
---

<Section className={Astro.props.className} title="Projects">
  <div class="grid grid-cols-1 gap-3 md:grid-cols-2 print:flex print:flex-col">
    {
      projects.map(
        ({ url, description, highlights, name, isActive, github, image }, index) => {
          const isBackgroundImage = image && image?.position === "background";
          const isContainerImage = image && image?.position === "container";

          // Grupo Fancybox único por proyecto
          const fancyboxGroup = `project-${index}`;

          // Lista de imágenes del folder si existe
          let imageList = [];
          if (image?.folder) {
            const folderPath = path.join(Astro.srcDir, "assets", image.folder);
            try {
              imageList = fs.readdirSync(folderPath)
                .filter(file => /\.(jpg|jpeg|png|gif|webp)$/i.test(file))
                .map(file => path.join(image.folder, file));
            } catch (err) {
              console.error(`Error leyendo carpeta de imágenes: ${folderPath}`, err);
            }
          } else if (image?.url) {
            imageList = [image.url];
          }

          return (
            <div
              role="contentinfo"
              class:list={[
                "project-container grid-span-1 group relative flex min-h-80 flex-col overflow-hidden rounded-md bg-skin-button-muted/50 p-5 shadow-sm ring-1 ring-skin-muted",
              ]}
            >
              {/* Encabezado */}
              <div class="relative z-10 flex items-center justify-between space-x-[10px]">
                <div class="flex items-center gap-2">
                  <Icon name="mdi:folder-outline" class="size-4" />
                  <div class="flex items-center gap-[6px]">
                    {isActive ? (
                      <a
                        class="group flex items-center gap-[6px] text-lg decoration-dotted underline-offset-[5px] hover:text-skin-hue hover:underline"
                        href={url}
                        target="_blank"
                      >
                        {name}
                        <span class="text-skin-hue transition ease-linear group-hover:-translate-y-0.5 group-hover:translate-x-0.5">
                          <Icon name="ri:arrow-up-line" class="rotate-45" />
                        </span>
                      </a>
                    ) : (
                      <span>{name}</span>
                    )}
                  </div>
                </div>

                {github && (
                  <a
                    href={github}
                    target="_blank"
                    rel="noopener"
                    class="opacity-75 transition duration-100 hover:scale-125 hover:opacity-100"
                  >
                    <Icon name="mdi:github" width={24} height={24} />
                  </a>
                )}
              </div>

              {/* Descripción */}
              <p class="relative z-10 py-3 text-sm text-skin-base">
                {description}
              </p>
              <ul class="relative z-10 mt-1 text-sm text-skin-inverted">
                {highlights.map(h => <li>{h}</li>)}
              </ul>

              {/* Reel de imágenes */}
              {isContainerImage && imageList.length > 0 && (
                <div class="mt-3 flex gap-2 overflow-x-auto">
                  {imageList.map((imgSrc) => (
                    <a data-src={imgSrc} data-fancybox={fancyboxGroup}>
                      <img
                        src={imgSrc}
                        alt=""
                        class="max-h-40 rounded-lg"
                      />
                    </a>
                  ))}
                </div>
              )}
            </div>
          );
        }
      )
    }
  </div>
</Section>

<script>
  import { Fancybox } from "@fancyapps/ui";
  Fancybox.bind("[data-fancybox]", { hideScrollbar: false });
</script>
