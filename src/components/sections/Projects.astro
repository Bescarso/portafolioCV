---
import Section from "../Section.astro";
import { Icon } from "astro-icon/components";
import { projects } from "@cv";

// Función para obtener imágenes de ImageKit
async function getImagesFromImageKit(folder) {
  const baseURL = "https://ik.imagekit.io/YOUR_IMAGEKIT_ID"; // Cambia por tu ID de ImageKit
  const response = await fetch(
    `https://api.imagekit.io/v1/files?path=${folder}&limit=20`,
    {
      headers: {
        Authorization: `Basic ${btoa("public_key:private_key")}`, // ⚠️ Mejor mover a backend si usas private_key
      },
    }
  );

  if (!response.ok) {
    console.error(`Error cargando imágenes para ${folder}`);
    return [];
  }

  const data = await response.json();
  return data.map((file) => `${baseURL}/${file.name}`);
}

// Obtenemos imágenes para cada proyecto
const projectsWithImages = await Promise.all(
  projects.map(async (project) => {
    const images = await getImagesFromImageKit(`portafolioCV/${project.folder}`);
    return { ...project, images };
  })
);
---

<Section className={Astro.props.className} title="Projects">
  <div class="grid grid-cols-1 gap-3 md:grid-cols-2 print:flex print:flex-col">
    {
      projectsWithImages.map(({ url, description, highlights, name, isActive, github, images }) => (
        <div
          role="contentinfo"
          class:list={[
            "project-container grid-span-1 group relative flex min-h-80 flex-col overflow-hidden rounded-md bg-skin-button-muted/50 p-5 shadow-sm ring-1 ring-skin-muted",
          ]}
        >
          {/* Encabezado */}
          <div class="relative z-10 flex items-center justify-between space-x-[10px]">
            <div class="flex items-center gap-2">
              <Icon name="mdi:folder-outline" class="size-4" />
              <div class="flex items-center gap-[6px]">
                {isActive ? (
                  <a
                    class="group flex items-center gap-[6px] text-lg decoration-dotted underline-offset-[5px] hover:text-skin-hue hover:underline"
                    href={url}
                    title={`Ver ${name}`}
                    target="_blank"
                  >
                    {name}
                    <span class="text-skin-hue transition ease-linear group-hover:-translate-y-0.5 group-hover:translate-x-0.5">
                      <Icon name="ri:arrow-up-line" class="rotate-45" />
                    </span>
                  </a>
                ) : (
                  <span>{name}</span>
                )}
              </div>
            </div>

            {github && (
              <a
                href={github}
                title="View repository on GitHub"
                target="_blank"
                rel="noopener"
                class="opacity-75 transition duration-100 hover:scale-125 hover:opacity-100"
              >
                <Icon name="mdi:github" width={24} height={24} />
              </a>
            )}
          </div>

          {/* Descripción */}
          <p class="relative z-10 py-3 text-sm text-skin-base">
            {description}
          </p>

          {/* Lista */}
          <ul class="relative z-10 mt-1 text-sm text-skin-inverted">
            {highlights.map((highlight) => <li>{highlight}</li>)}
          </ul>

          {/* Reel de imágenes */}
          <div class="mt-3 flex flex-wrap gap-2">
            {images.map((imgUrl, index) => (
              <a
                href={imgUrl}
                data-fancybox={`project-${name}`}
                data-caption={`${name} - Imagen ${index + 1}`}
              >
                <img
                  src={imgUrl}
                  alt={`${name} ${index + 1}`}
                  class="w-28 h-28 object-cover rounded-md hover:opacity-80 transition"
                />
              </a>
            ))}
          </div>
        </div>
      ))
    }
  </div>
</Section>

<script>
  import { Fancybox } from "@fancyapps/ui";
  Fancybox.bind("[data-fancybox]", { hideScrollbar: false });
</script>

<style>
  ul {
    @apply ml-4 list-disc space-y-1;
    li {
      @apply text-skin-muted;
    }
  }
</style>
